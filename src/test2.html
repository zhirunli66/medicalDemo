
<!DOCTYPE html>
<html>
  <head>
    <title>JavaScript file upload</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <!-- <script src="https://wzrd.in/standalone/buffer"></script> -->
    <script src="https://bundle.run/buffer@5.4.0"></script>
    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js"
    integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB"
    crossorigin="anonymous"></script>
  </head>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="js/web3.min.js"></script>
  <script src="js/truffle-contract.js"></script>
  <script type='text/javascript' src="js/app.js"></script>
  <script>
    const provider = new Web3.providers.HttpProvider('http://localhost:8545');
    const web3 = new Web3(provider);
  
    web3.eth.getCoinbase(function(err, account) {
       // alert(account);
        if (err === null) {
          alert("1");
          alert("AcR"+account);
        //  $("#accountAddress").html("当前登录账户地址: " + account);  
        unlockAccount(account,"123456",60); 
        alert("UU3");
        
          }else{
  
            alert("2");
          
          }
      });
  
  </script>
  <script>
    function unlockAccount(ac,pw){
      alert("UU0");
       web3.personal.unlockAccount(ac,pw);
 alert("UU1");

    }

</script>
  <script type="text/javascript">

  
    function upload() {

      const reader = new FileReader();
      reader.onloadend = function() {
        const ipfs = window.IpfsApi('127.0.0.1', 5001) // Connect to IPFS
        const buf = buffer.Buffer(reader.result) // Convert data into buffer
        ipfs.files.add(buf, (err, result) => { // Upload buffer to IPFS
          if(err) {
            console.error(err)
            return
          }
    
          var abi=null;
          var contractAddress="0x8e21b1fB89f66Aa2f6812dd8d8cBe06556E54d1f";
          
          $.getJSON('StorageIpfs.json', function(data){
 
            abi = data.abi;
            var StorageIpfs = web3.eth.contract(abi);
            var sipfs = StorageIpfs.at(contractAddress);    
            web3.eth.defaultAccount=web3.eth.coinbase;
            var uad=web3.eth.coinbase;
        
            var h= result[0].hash;  //record the hash
         
            if(!StorageIpfs.hasHash(h)){
               alert("Existed");
              }else{
                var myEvent = StorageIpfs.StorageE();
                var txHash=StorageIpfs.storeHashToAddress(uad,h,{from: web3.eth.defaultAccount,gas:3000000});
                    myEvent.watch(function(err, result) {

                       if (!err) {
                            console.log(result);

                            if(result.transactionHash == txHash){
                           // var acb = StorageIpfs.getAddressByHash.call(web3.eth.defaultAccount);
                           var hashSet =  StorageIpfs.findHashByAddress(uad);
                           var l=hashSet.length;
                           for (i=0;i<l;i++){

                            let url = `http://127.0.0.1:8080/ipfs/${result[i].hash}`
                            document.getElementById("url"+i).innerHTML= url
                           }
                            
                      }else{
                           alert("HHH:"+result.transactionHash);
                         }
                     } else {
                         alert("JJJ");
                         console.log(err);
                      }

             myEvent.stopWatching();
     });

}

});

        })
      }
      const photo = document.getElementById("photo");
      reader.readAsArrayBuffer(photo.files[0]); // Read Provided File
    }
  </script>
  
  
  <body>

    <div> Upload Image
    <form action="/">
      <fieldset>
        <legend>Upload photo</legend>
        <input type="file" name="photo" id="photo" multiple="multiple">
        <button type="button" onclick="upload()">Upload</button>
      </fieldset>
    </form>
    </br>
    </br>
    <a id="url0"></a>
    <a id="url1"></a>
    <a id="url2"></a>
    <a id="url3"></a>
    <a id="url4"></a>
    </br>
    </br>
    <img id="output">
</div>



  </body>
</html>